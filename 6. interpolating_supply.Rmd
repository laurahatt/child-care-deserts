---
title: "6. interpolating supply"
author: "Laura Hatt"
date: '2023-03-05'
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

CAP doesn't interpolate, they just show the dots
the paper also does not interpolate - they calculate summary statistics
however, I want to interpolate

```{r, warning = FALSE}
library(sf)
library(tmap)
library(tidyverse)

path = "/Users/laurahatt/Documents/GitHub/child-care-deserts/"
```

```{r}
fam_supply_by10 <- read_sf(paste0(path, "Shapefiles/fam_supply_by10.shp"))
```

```{r, message = FALSE}
comm_areas <- st_read(paste0(path, "Inputs/comm_areas.geojson"))
comm_areas <- st_transform(comm_areas, "EPSG:3435")
lakeview <- comm_areas %>% filter(community == "LAKE VIEW")
```

```{r, warning = FALSE}
#creating Voronoi polygons and matching to data points, per these instructions
#https://search.r-project.org/CRAN/refmans/sf/html/geos_unary.html
pols <- st_collection_extract(st_voronoi(do.call(c, st_geometry(fam_supply_by10))))
pols <- st_set_crs(pols, "EPSG:3435") #this is the underlying fam_supply_by10 CRS
fam_supply_by10$pols <- pols[unlist(st_intersects(fam_supply_by10, pols))]

#remove point geometry column 
supply_voro <- st_set_geometry(fam_supply_by10, NULL) %>% select(FID, AdjSup, pols)
supply_voro <- st_as_sf(supply_voro)

#clip voronoi polygons to neighborhood boundaries
supply_voro <- st_intersection(supply_voro, lakeview)
supply_voro <- supply_voro %>% select(FID, AdjSup)

#ALT METHOD: st_join(pols, fam_AdjSup_samp, st_intersects)
```


```{r}
#https://stackoverflow.com/questions/71025852/merge-st-voronoi-polygons-by-variable

supply_voro$AdjSupRd <- round(supply_voro$AdjSup, 2)

supply_voro_comb <- supply_voro %>% 
  group_by(AdjSupRd) %>%
  summarize()
```


```{r}
tmap_mode("plot")

#expand bounding box to make room for map elements
#https://www.jla-data.net/eng/adjusting-bounding-box-of-a-tmap-map/
bbox_new <- st_bbox(lakeview) 
xrange <- bbox_new$xmax - bbox_new$xmin 
yrange <- bbox_new$ymax - bbox_new$ymin 
bbox_new[3] <- bbox_new[3] + (0.4 * xrange) 
bbox_new[2] <- bbox_new[2] - (0.2 * yrange) 
bbox_new <- bbox_new %>% st_as_sfc() 

map_slots_per_child_voronoi <- tm_shape(lakeview, bbox=bbox_new) + tm_polygons() +
  tm_shape(supply_voro_comb) + tm_polygons(col="AdjSupRd", 
                                           palette="RdBu",
                                           title=" ") +
  tm_layout(main.title = "Child Care Supply in Lakeview: \nSlots Per Child (Voronoi Tessellation)",
            main.title.size = 1.25,
            main.title.position = "center",
            legend.position = c("right", "center")) +
  tm_compass(type = "4star", size = 2, position = c("right", "top")) + 
  tm_scale_bar(position = c("left", "bottom"), text.size = 0.5, breaks = c(0, 0.5, 1)) +
  tm_credits("Created by Laura Hatt", fontface = "bold", position = c("right", "bottom"), size = 0.5) +
  tm_credits("6 March 2023", position = c("right", "bottom"), size = 0.5)
tmap_save(map_slots_per_child_voronoi, paste0(path, "Maps/map_slots_per_child_voronoi.png"))

map_slots_per_child_voronoi
```

In order to define a "child care desert", one must define some kind of threshold. There is no consensus about this threshold, especially in terms of walking time.

```{r}

#The mean is 0.0271 slots per children.
mean(st_set_geometry(supply_voro['AdjSup'], NULL)$AdjSup)

#46.85% of families in Lakeview do not have any licensed childcare providers 
#within a 15-minute walk of their house
ecdf(st_set_geometry(supply_voro, NULL)$AdjSup)(0)

#the percentiles are as follows
quantile(st_set_geometry(supply_voro, NULL)$AdjSup, probs = seq(0, 1, by= 0.1)) 
```


```{r}
#transforming supply into binary measure: zero or nonzero
supply_voro$nonzero <-factor(ifelse(supply_voro$AdjSup==0,"Zero","More than zero"),
                             levels = c("Zero", "More than zero"))

#combining Voronoi polygons with the same value
supply_voro_nonzero <- supply_voro %>% 
  group_by(nonzero) %>%
  summarize()

map_zero_slots_voronoi <- tm_shape(lakeview, bbox=bbox_new) + tm_polygons() +
  tm_shape(supply_voro_nonzero) + tm_polygons(col="nonzero", 
                                           palette="RdBu",
                                           title=" ") +
  tm_layout(main.title = "Child Care Supply in Lakeview: \nRegions with Zero Slots (Voronoi Tessellation)",
            main.title.size = 1.25,
            main.title.position = "center", 
            legend.position = c("right", "center")) + 
  tm_compass(type = "4star", size = 2, position = c("right", "top")) + 
  tm_scale_bar(position = c("left", "bottom"), text.size = 0.5, breaks = c(0, 0.5, 1)) +
  tm_credits("Created by Laura Hatt", fontface = "bold", position = c("right", "bottom"), size = 0.5) +
  tm_credits("6 March 2023", position = c("right", "bottom"), size = 0.5)
tmap_save(map_zero_slots_voronoi, paste0(path, "Maps/map_zero_slots_voronoi.png"))

map_zero_slots_voronoi
```














