---
title: "6. interpolating supply"
author: "Laura Hatt"
date: '2023-03-05'
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

CAP doesn't interpolate, they just show the dots
the paper also does not interpolate - they calculate summary statistics
however, I want to interpolate

```{r}
#library(terra)
library(sf)
library(tmap)
library(tidyverse)

path = "/Users/laurahatt/Documents/GitHub/child-care-deserts/"
```

```{r}
fam_supply_by10 <- read_sf(paste0(path, "Shapefiles/fam_supply_by10.shp"))
```

```{r}
comm_areas <- st_read(paste0(path, "Inputs/comm_areas.geojson"))
comm_areas <- st_transform(comm_areas, "EPSG:3435")
lakeview <- comm_areas %>% filter(community == "LAKE VIEW")
```

```{r}
#creating Voronoi polygons and matching to data points, per these instructions
#https://search.r-project.org/CRAN/refmans/sf/html/geos_unary.html
pols <- st_collection_extract(st_voronoi(do.call(c, st_geometry(fam_supply_by10))))
pols <- st_set_crs(pols, "EPSG:3435") #this is the underlying fam_supply_by10 CRS
fam_supply_by10$pols <- pols[unlist(st_intersects(fam_supply_by10, pols))]

#remove point geometry column 
supply_voro <- st_set_geometry(fam_supply_by10, NULL) %>% select(FID, AdjSup, pols)
supply_voro <- st_as_sf(supply_voro)

#clip voronoi polygons to neighborhood boundaries
supply_voro <- st_intersection(supply_voro, lakeview)
supply_voro <- supply_voro %>% select(FID, AdjSup)

#ALT METHOD: st_join(pols, fam_AdjSup_samp, st_intersects)
```


```{r}
map_supply_voro <- tm_shape(lakeview) + tm_polygons() + 
  tm_shape(supply_voro) + tm_polygons(col = "AdjSup", palette="RdBu")

tmap_save(map_supply_voro, paste0(path, "Maps/map_supply_voro.png"))
map_supply_voro
```


```{r}
#https://stackoverflow.com/questions/71025852/merge-st-voronoi-polygons-by-variable

supply_voro$AdjSupRd <- round(supply_voro$AdjSup, 2)

supply_voro_comb <- supply_voro %>% 
  group_by(AdjSupRd) %>%
  summarize()
```


```{r}
map_supply_smooth <- tm_shape(lakeview) + tm_polygons() +
  tm_shape(supply_voro_comb) + tm_polygons(col="AdjSupRd", 
                                           palette="RdBu",
                                           title="Slots per child under 6YO") +
  tm_layout(main.title = "Child care supply in Lakeview, Chicago",
            legend.outside = TRUE,
            legend.outside.position = "right")

tmap_save(map_supply_smooth, paste0(path, "Maps/map_supply_smooth.png"))
tmap_mode("view")
map_supply_smooth
```

In order to define a "child care desert", one must define some kind of threshold. There is no consensus about this threshold, especially in terms of walking time.

```{r}

#The mean is 0.0271 slots per children.
mean(st_set_geometry(supply_voro['AdjSup'], NULL)$AdjSup)

#46.85% of families in Lakeview do not have any licensed childcare providers 
#within a 15-minute walk of their house
ecdf(st_set_geometry(supply_voro, NULL)$AdjSup)(0)

#the percentiles are as follows
quantile(st_set_geometry(supply_voro, NULL)$AdjSup, probs = seq(0, 1, by= 0.1)) 

#now transform and map
supply_voro$nonzero <- as.numeric(st_set_geometry(supply_voro, NULL)$AdjSup > 0)
supply_voro
```

```{r}
tmap_mode("plot")

tm_shape(lakeview) + tm_polygons() + 
  tm_shape(supply_voro) + tm_polygons(col = "nonzero", 
                                      palette="RdBu")
```




